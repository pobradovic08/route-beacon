# docker-compose.yaml -- Local development environment for route-beacon.
#
# Usage:
#   docker compose -f deployments/docker-compose.yaml up --build
#
# Requires a running PostgreSQL instance populated by route-beacon-ri.
# The API joins the route-beacon-ri network (docker_testnet) to reach
# the postgres container directly.

name: route-beacon

# Services:
#   api         - Go API server (read-only queries against external database)
#   web         - React frontend (Vite dev server) proxying /api/ to api service
#
# The frontend is exposed on http://localhost:3040.
# The API is also exposed directly on http://localhost:8080.

services:
  # ---------- Go API server ----------
  api:
    build:
      context: ../
      dockerfile: deployments/docker/Dockerfile.api
    ports:
      - "8080:8080"
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://rib:rib@docker-postgres-1:5432/rib}
      LISTEN_ADDR: ":8080"
    restart: unless-stopped
    networks:
      - docker_testnet

  # ---------- Web frontend (Vite dev server with HMR) ----------
  web:
    image: node:22-alpine
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    depends_on:
      api:
        condition: service_started
    ports:
      - "3040:3000"
    volumes:
      - ../web:/app
      - web_node_modules:/app/node_modules
    restart: unless-stopped
    networks:
      - docker_testnet

networks:
  docker_testnet:
    external: true

volumes:
  web_node_modules:
    driver: local
