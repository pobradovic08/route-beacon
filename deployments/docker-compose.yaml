# docker-compose.yaml -- Local development environment for route-beacon.
#
# Usage:
#   docker compose -f deployments/docker-compose.yaml up --build
#

name: route-beacon
# Services:
#   cert-init   - One-shot init container that generates self-signed mTLS certs
#   central     - Central API + gRPC server
#   web         - React frontend (nginx) proxying to central
#   collector   - Collector that connects to central via gRPC
#   bgp-router1 - FRR BGP router (AS 65001) announcing test prefixes
#   bgp-router2 - FRR BGP router (AS 65002) announcing test prefixes
#
# The frontend is exposed on http://localhost:3040.
# The API is also exposed directly on http://localhost:8080.
#
# Network layout (172.28.0.0/24):
#   central      172.28.0.2
#   bgp-router1  172.28.0.10  (AS 65001 "ISP Alpha")
#   bgp-router2  172.28.0.11  (AS 65002 "ISP Beta")
#   collector    172.28.0.20  (AS 64512)

services:
  # ---------- Certificate generation (init) ----------
  cert-init:
    image: alpine:3.21
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apk add --no-cache openssl >/dev/null 2>&1
        sh /scripts/gen-dev-certs.sh
    volumes:
      - certs:/certs
      - ./docker/gen-dev-certs.sh:/scripts/gen-dev-certs.sh:ro
    environment:
      CERT_DIR: /certs
      CERT_DAYS: "3650"
    networks:
      bgpnet:

  # ---------- Central server ----------
  central:
    build:
      context: ../
      dockerfile: deployments/docker/Dockerfile.central
    depends_on:
      cert-init:
        condition: service_completed_successfully
    ports:
      - "8080:8080"   # HTTP API
      - "9090:9090"   # gRPC
      - "9091:9091"   # Prometheus metrics
    volumes:
      - certs:/etc/route-beacon/certs:ro
      - ./configs/central.dev.yaml:/etc/route-beacon/central.yaml:ro
    restart: unless-stopped
    networks:
      bgpnet:
        ipv4_address: 172.28.0.2

  # ---------- Web frontend ----------
  web:
    build:
      context: ../
      dockerfile: deployments/docker/Dockerfile.web
    depends_on:
      central:
        condition: service_started
    ports:
      - "3040:3000"
    restart: unless-stopped
    networks:
      bgpnet:

  # ---------- Collector ----------
  collector:
    build:
      context: ../
      dockerfile: deployments/docker/Dockerfile.collector
    depends_on:
      cert-init:
        condition: service_completed_successfully
      central:
        condition: service_started
      bgp-router1:
        condition: service_started
      bgp-router2:
        condition: service_started
    cap_add:
      - NET_RAW     # required for ping (raw ICMP sockets)
    volumes:
      - certs:/etc/route-beacon/certs:ro
      - ./configs/collector.dev.yaml:/etc/route-beacon/collector.yaml:ro
    restart: unless-stopped
    networks:
      bgpnet:
        ipv4_address: 172.28.0.20

  # ---------- BGP Router 1 (AS 65001, "ISP Alpha") ----------
  bgp-router1:
    image: frrouting/frr:latest
    hostname: bgp-router1
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    volumes:
      - ./configs/frr-daemons:/etc/frr/daemons:ro
      - ./configs/frr-router1.conf:/etc/frr/frr.conf:ro
    restart: unless-stopped
    networks:
      bgpnet:
        ipv4_address: 172.28.0.10

  # ---------- BGP Router 2 (AS 65002, "ISP Beta") ----------
  bgp-router2:
    image: frrouting/frr:latest
    hostname: bgp-router2
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    volumes:
      - ./configs/frr-daemons:/etc/frr/daemons:ro
      - ./configs/frr-router2.conf:/etc/frr/frr.conf:ro
    restart: unless-stopped
    networks:
      bgpnet:
        ipv4_address: 172.28.0.11

networks:
  bgpnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24

volumes:
  certs:
    driver: local
